<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="format-detection" content="telephone=no"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><link rel="icon" href="/favicon/favicon-16x16.png?v=2.6.2" type="image/png" sizes="16x16"><link rel="icon" href="/favicon/favicon-32x32.png?v=2.6.2" type="image/png" sizes="32x32"><link rel="apple-touch-icon" href="/favicon/apple-touch-icon.png?v=2.6.2" sizes="180x180"><meta name="description" content="PyTorch 中的侵入式指针。">
<meta property="og:type" content="article">
<meta property="og:title" content="PyTorch 源码阅读：intrusive_ptr">
<meta property="og:url" content="https://aurumting.cn/2021/12/07/PyTorch_intrusive_ptr/index.html">
<meta property="og:site_name" content="Aurumting&#39;s Blog">
<meta property="og:description" content="PyTorch 中的侵入式指针。">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2021-12-07T14:00:42.114Z">
<meta property="article:modified_time" content="2021-12-15T13:08:18.142Z">
<meta property="article:author" content="Aurumting">
<meta property="article:tag" content="PyTorch">
<meta name="twitter:card" content="summary"><title>PyTorch 源码阅读：intrusive_ptr | Aurumting's Blog</title><link ref="canonical" href="https://aurumting.cn/2021/12/07/PyTorch_intrusive_ptr/"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.12.1/css/all.min.css" type="text/css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" type="text/css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@latest/dist/gitalk.min.css" type="text/css"><link rel="stylesheet" href="/css/index.css?v=2.6.2"><script>var Stun = window.Stun || {};
var CONFIG = {
  root: '/',
  algolia: undefined,
  assistSearch: undefined,
  fontIcon: {"prompt":{"success":"fas fa-check-circle","info":"fas fa-arrow-circle-right","warning":"fas fa-exclamation-circle","error":"fas fa-times-circle"},"copyBtn":"fas fa-copy"},
  sidebar: {"offsetTop":"20px","tocMaxDepth":6},
  header: undefined,
  postWidget: {"endText":true},
  nightMode: {"enable":true},
  back2top: {"enable":true},
  codeblock: {"style":"default","highlight":"light","wordWrap":false},
  reward: false,
  fancybox: true,
  zoomImage: {"gapAside":"20px"},
  galleryWaterfall: undefined,
  lazyload: false,
  pjax: undefined,
  externalLink: {"icon":{"enable":true,"name":"fas fa-external-link-alt"}},
  shortcuts: undefined,
  prompt: {"copyButton":"复制","copySuccess":"复制成功","copyError":"复制失败"},
  sourcePath: {"js":"js","css":"css","images":"images"},
};

window.CONFIG = CONFIG;</script><meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="Aurumting's Blog" type="application/atom+xml">
</head><body><div class="container" id="container"><header class="header" id="header"><div class="header-inner header-inner--height header-inner--bgcolor"><nav class="header-nav header-nav--sticky"><div class="header-nav-inner"><div class="header-nav-menubtn"><i class="fas fa-bars"></i></div><div class="header-nav-menu"><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/"><span class="header-nav-menu-item__icon"><i class="fas fa-home"></i></span><span class="header-nav-menu-item__text">首页</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/archives/"><span class="header-nav-menu-item__icon"><i class="fas fa-folder-open"></i></span><span class="header-nav-menu-item__text">归档</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/categories/"><span class="header-nav-menu-item__icon"><i class="fas fa-layer-group"></i></span><span class="header-nav-menu-item__text">分类</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/tags/"><span class="header-nav-menu-item__icon"><i class="fas fa-tags"></i></span><span class="header-nav-menu-item__text">标签</span></a></div></div><div class="header-nav-mode"><div class="mode"><div class="mode-track"><span class="mode-track-moon"></span><span class="mode-track-sun"></span></div><div class="mode-thumb"></div></div></div></div></nav></div></header><main class="main" id="main"><div class="main-inner"><div class="content-wrap" id="content-wrap"><div class="content" id="content"><!-- Just used to judge whether it is an article page--><div id="is-post"></div><div class="post"><header class="post-header"><h1 class="post-title">PyTorch 源码阅读：intrusive_ptr</h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">发表于</span><span class="post-meta-item__value">2021-12-07</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">更新于</span><span class="post-meta-item__value">2021-12-15</span></span><span class="post-meta-item post-meta-item--visitors"><span class="post-meta-item__icon"><i class="fas fa-eye"></i></span><span class="post-meta-item__info">阅读次数</span><span class="post-meta-item__value" id="busuanzi_value_page_pv"></span></span></div></header><div class="post-body"><p>PyTorch 中的侵入式指针。</p>
<span id="more"></span>

        <h1 id="in_place"   >
          <a href="#in_place" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#in_place"></a> in_place</h1>
      
<p>先看一下 <code>in_place.h</code>，里面是一些简单的定义：</p>
<figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">in_place_t</span> &#123;</span></span><br><span class="line">    <span class="function"><span class="keyword">explicit</span> <span class="title">in_place_t</span><span class="params">()</span> </span>= <span class="keyword">default</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;std::<span class="keyword">size_t</span> I&gt;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">in_place_index_t</span> &#123;</span></span><br><span class="line">    <span class="function"><span class="keyword">explicit</span> <span class="title">in_place_index_t</span><span class="params">()</span> </span>= <span class="keyword">default</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">in_place_type_t</span> &#123;</span></span><br><span class="line">    <span class="function"><span class="keyword">explicit</span> <span class="title">in_place_type_t</span><span class="params">()</span> </span>= <span class="keyword">default</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">constexpr</span> <span class="keyword">in_place_t</span> in_place&#123;&#125;;</span><br></pre></td></tr></table></div></figure>
<p>其中定义了一些类和模板类，另外还有一个 <code>in_place_t</code> 类型的变量 <code>in_place</code>，默认初始化。</p>

        <h1 id="exclusivelyowned"   >
          <a href="#exclusivelyowned" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#exclusivelyowned"></a> ExclusivelyOwned</h1>
      
<p><code>ExclusivelyOwned</code> 是一个类似于智能指针的包装，围绕着某个类型 <code>T</code> 的排他性拥有的实例，该类型通常具有强制性引用计数（目前是 <code>Tensor</code> 或  <code>c10::intrusive_ptr</code>）。如果你有一段孤立的代码，知道它对这些类型中的一个对象拥有唯一的所有权（即，因为你直接创建了它或者使用了工厂函数），并且该对象不会从这段孤立的代码中逃脱，那么将该对象移入 <code>ExclusivelyOwned</code> 将避免在销毁时进行原子引用计数递减。</p>
<p>如果你首先直接创建 <code>Tensor/intrusive_ptr</code>，你可以使用 <code>ExclusivelyOwned</code> 的 <code>in_place</code> 构造函数来避免做任何存储来初始化引用计数和弱引用计数（然而，请注意，在这种情况下，如果适用，你可能应该使用 <code>std::unique_ptr</code> 而不是 <code>intrusive_ptr</code>）。</p>
<p><code>ExclusivelyOwned</code> 类（删减版）：</p>
<figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ExclusivelyOwned</span> &#123;</span></span><br><span class="line">    <span class="keyword">using</span> EOT = ExclusivelyOwnedTraits&lt;T&gt;;</span><br><span class="line">    <span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">        <span class="keyword">char</span> dummy_;</span><br><span class="line">        <span class="keyword">typename</span> ExclusivelyOwnedTraits&lt;T&gt;::repr_type repr_;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">ExclusivelyOwned</span>() : <span class="built_in">repr_</span>(EOT::<span class="built_in">nullRepr</span>()) &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">ExclusivelyOwned</span>(<span class="keyword">const</span> ExclusivelyOwned&amp;) = <span class="keyword">delete</span>;</span><br><span class="line"></span><br><span class="line">    ExclusivelyOwned&amp; <span class="keyword">operator</span>=(<span class="keyword">const</span> ExclusivelyOwned&amp;) = <span class="keyword">delete</span>;</span><br><span class="line"></span><br><span class="line">    ~<span class="built_in">ExclusivelyOwned</span>() &#123;</span><br><span class="line">        EOT::<span class="built_in">destroyOwned</span>(repr_);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">explicit</span> <span class="keyword">operator</span> <span class="title">bool</span><span class="params">()</span> <span class="keyword">const</span> <span class="keyword">noexcept</span> </span>= <span class="keyword">delete</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">operator</span> <span class="title">T</span><span class="params">()</span> &amp;&amp; </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">take</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">T <span class="title">take</span><span class="params">()</span> &amp;&amp; </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> EOT::<span class="built_in">take</span>(repr_);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">typename</span> EOT::pointer_type <span class="keyword">operator</span>-&gt;() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">get</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">typename</span> EOT::pointer_type <span class="title">get</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> EOT::<span class="built_in">getImpl</span>(repr_);</span><br><span class="line">    &#125;</span><br><span class="line">   </span><br><span class="line">    std::<span class="keyword">remove_pointer_t</span>&lt;<span class="keyword">typename</span> EOT::pointer_type&gt;&amp; <span class="keyword">operator</span>*() &#123;</span><br><span class="line">        <span class="keyword">return</span> *<span class="built_in">get</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></div></figure>
<p>其中主要用到的 <code>ExclusivelyOwnedTraits</code> 实现如下（删减版）：</p>
<figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ExclusivelyOwnedTraits</span>&lt;</span>c10::intrusive_ptr&lt;T&gt;&gt; &#123;</span><br><span class="line">    <span class="keyword">using</span> repr_type = T*;</span><br><span class="line">    <span class="keyword">using</span> pointer_type = T*;</span><br><span class="line">    <span class="keyword">using</span> const_pointer_type = T*;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">template</span> &lt;class... Args&gt;</span><br><span class="line">    <span class="function"><span class="keyword">static</span> repr_type <span class="title">createInPlace</span><span class="params">(Args&amp;&amp;... args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">T</span>(std::forward&lt;Args&gt;(args)...);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">static</span> repr_type <span class="title">moveToRepr</span><span class="params">(c10::intrusive_ptr&lt;T&gt;&amp;&amp; x)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> x.<span class="built_in">release</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">destroyOwned</span><span class="params">(repr_type x)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!x) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">const_cast</span>&lt;std::<span class="keyword">remove_const_t</span>&lt;T&gt;*&gt;(x)-&gt;<span class="built_in">release_resources</span>();</span><br><span class="line">        <span class="meta">#<span class="meta-keyword">ifndef</span> NDEBUG</span></span><br><span class="line">            x-&gt;refcount_ = <span class="number">0</span>;</span><br><span class="line">            x-&gt;weakcount_ = <span class="number">0</span>;</span><br><span class="line">        <span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">        x-&gt;<span class="built_in">release_resources</span>();</span><br><span class="line">        <span class="keyword">delete</span> x;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">static</span> c10::intrusive_ptr&lt;T&gt; <span class="title">take</span><span class="params">(repr_type&amp; x)</span> </span>&#123;</span><br><span class="line">        <span class="meta">#<span class="meta-keyword">ifndef</span> NDEBUG</span></span><br><span class="line">            x-&gt;refcount_ = <span class="number">0</span>;</span><br><span class="line">            x-&gt;weakcount_ = <span class="number">0</span>;</span><br><span class="line">        <span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">            <span class="keyword">auto</span> result = c10::intrusive_ptr&lt;T&gt;(x);</span><br><span class="line">            x = <span class="literal">nullptr</span>;</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">static</span> pointer_type <span class="title">getImpl</span><span class="params">(repr_type x)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> x;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></div></figure>
<p><code>ExclusivelyOwnedTraits</code> 中全是静态方法，相当于一个包装类。</p>

        <h1 id="maybeowned"   >
          <a href="#maybeowned" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#maybeowned"></a> MaybeOwned</h1>
      
<p><code>MaybeOwnedTraits&lt;T&gt;</code> 描述了如何从 <code>T</code> 中借入。下面是我们如何实现从一个任意类型的 <code>T</code> 中借入，使用一个原始指针到 <code>const</code> ：</p>
<figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">MaybeOwnedTraitsGenericImpl</span> &#123;</span></span><br><span class="line">    <span class="keyword">using</span> owned_type = T;</span><br><span class="line">    <span class="keyword">using</span> borrow_type = <span class="keyword">const</span> T*;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">static</span> borrow_type <span class="title">createBorrow</span><span class="params">(<span class="keyword">const</span> owned_type&amp; from)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> &amp;from;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">assignBorrow</span><span class="params">(borrow_type&amp; lhs, borrow_type rhs)</span> </span>&#123;</span><br><span class="line">        lhs = rhs;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">destroyBorrow</span><span class="params">(borrow_type&amp; toDestroy)</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">const</span> owned_type&amp; <span class="title">referenceFromBorrow</span><span class="params">(<span class="keyword">const</span> borrow_type&amp; borrow)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> *borrow;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">const</span> owned_type* <span class="title">pointerFromBorrow</span><span class="params">(<span class="keyword">const</span> borrow_type&amp; borrow)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> borrow;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">bool</span> <span class="title">debugBorrowIsValid</span><span class="params">(<span class="keyword">const</span> borrow_type&amp; borrow)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> borrow != <span class="literal">nullptr</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></div></figure>
<p><code>MaybeOwnedTraitsGenericImpl</code> 类没有成员变量，且其中所有方法都是静态的。主要围绕两个类型：<code>owned_type</code> 和 <code>borrow_type</code> 展开，其中 <code>owned_type</code> 就是类型 <code>T</code> ，而 <code>borrow_type</code> 是指向常量类型 <code>T</code> 的指针。</p>
<p>对于一些我们控制的类型，有可能消除借用的额外指示层。</p>
<figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">MaybeOwnedTraits</span>;</span></span><br></pre></td></tr></table></div></figure>
<p>明确地启用 <code>MaybeOwned&lt;shared_ptr&lt;T&gt;&gt;</code> ，而不是允许 <code>MaybeOwned</code> 立即用于任何类型：</p>
<figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">MaybeOwnedTraits</span>&lt;</span>std::shared_ptr&lt;T&gt;&gt;</span><br><span class="line">    : <span class="keyword">public</span> MaybeOwnedTraitsGenericImpl&lt;std::shared_ptr&lt;T&gt;&gt; &#123;&#125;;</span><br></pre></td></tr></table></div></figure>
<p><code>MaybeOwnedTraits</code> 实现：</p>
<figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">MaybeOwnedTraits</span>&lt;</span>c10::intrusive_ptr&lt;T&gt;&gt; &#123;</span><br><span class="line">    <span class="keyword">using</span> owned_type = c10::intrusive_ptr&lt;T&gt;;</span><br><span class="line">    <span class="keyword">using</span> borrow_type = c10::intrusive_ptr&lt;T&gt;;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">static</span> borrow_type <span class="title">createBorrow</span><span class="params">(<span class="keyword">const</span> owned_type&amp; from)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> borrow_type::<span class="built_in">reclaim</span>(from.<span class="built_in">get</span>());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">assignBorrow</span><span class="params">(borrow_type&amp; lhs, <span class="keyword">const</span> borrow_type&amp; rhs)</span> </span>&#123;</span><br><span class="line">        lhs.<span class="built_in">release</span>();</span><br><span class="line">        lhs = borrow_type::<span class="built_in">reclaim</span>(rhs.<span class="built_in">get</span>());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">destroyBorrow</span><span class="params">(borrow_type&amp; toDestroy)</span> </span>&#123;</span><br><span class="line">        toDestroy.<span class="built_in">release</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">const</span> owned_type&amp; <span class="title">referenceFromBorrow</span><span class="params">(<span class="keyword">const</span> borrow_type&amp; borrow)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> borrow;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">const</span> owned_type* <span class="title">pointerFromBorrow</span><span class="params">(<span class="keyword">const</span> borrow_type&amp; borrow)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> &amp;borrow;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">bool</span> <span class="title">debugBorrowIsValid</span><span class="params">(<span class="keyword">const</span> borrow_type&amp; borrow)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></div></figure>
<p>和上面的一样，相当于一层包装器。</p>
<p>围绕借来的或拥有的 <code>T</code> 的智能指针。当用 <code>borrowed()</code> 构造时，调用者必须确保借来的参数超过这个 <code>MaybeOwned&lt;T&gt;</code> 。与 <span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.rust-lang.org/" >Rust</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span> 的 <span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://doc.rust-lang.org/std/borrow/enum.Cow.html" >std::borrow::Cow</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span> 相比，但请注意，它可能不适合一般使用，因为 <code>C++</code> 没有借入检查。包括在这里以支持 <code>Tensor::expect_contiguous</code> 。</p>
<figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MaybeOwned</span> <span class="keyword">final</span> &#123;</span></span><br><span class="line">    <span class="keyword">using</span> borrow_type = <span class="keyword">typename</span> MaybeOwnedTraits&lt;T&gt;::borrow_type;</span><br><span class="line">    <span class="keyword">using</span> owned_type = <span class="keyword">typename</span> MaybeOwnedTraits&lt;T&gt;::owned_type;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">bool</span> isBorrowed_;</span><br><span class="line">    <span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">        borrow_type borrow_;</span><br><span class="line">        owned_type own_;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Don&#x27;t use this; use borrowed() instead.</span></span><br><span class="line">    <span class="function"><span class="keyword">explicit</span> <span class="title">MaybeOwned</span><span class="params">(<span class="keyword">const</span> owned_type&amp; t)</span></span></span><br><span class="line"><span class="function">        : isBorrowed_(true), borrow_(MaybeOwnedTraits&lt;T&gt;::createBorrow(t)) &#123;</span>&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Don&#x27;t use this; use owned() instead.</span></span><br><span class="line">    <span class="function"><span class="keyword">explicit</span> <span class="title">MaybeOwned</span><span class="params">(T&amp;&amp; t)</span> <span class="title">noexcept</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        std::is_nothrow_move_constructible&lt;T&gt;::value)</span></span></span><br><span class="line"><span class="function">        : isBorrowed_(false), own_(std::move(t)) &#123;</span>&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Don&#x27;t use this; use owned() instead.</span></span><br><span class="line">    <span class="keyword">template</span> &lt;class... Args&gt;</span><br><span class="line">    <span class="function"><span class="keyword">explicit</span> <span class="title">MaybeOwned</span><span class="params">(<span class="keyword">in_place_t</span>, Args&amp;&amp;... args)</span></span></span><br><span class="line"><span class="function">        : isBorrowed_(false), own_(std::forward&lt;Args&gt;(args)...) &#123;</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">explicit</span> <span class="title">MaybeOwned</span><span class="params">()</span> : isBorrowed_(true), borrow_() &#123;</span>&#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">MaybeOwned</span>(<span class="keyword">const</span> MaybeOwned&amp; rhs) : <span class="built_in">isBorrowed_</span>(rhs.isBorrowed_) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">C10_LIKELY</span>(rhs.isBorrowed_)) &#123;</span><br><span class="line">            MaybeOwnedTraits&lt;T&gt;::<span class="built_in">assignBorrow</span>(borrow_, rhs.borrow_);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in"><span class="keyword">new</span></span> (&amp;own_) <span class="built_in">T</span>(rhs.own_);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    MaybeOwned&amp; <span class="keyword">operator</span>=(<span class="keyword">const</span> MaybeOwned&amp; rhs) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span> == &amp;rhs) &#123;</span><br><span class="line">            <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">C10_UNLIKELY</span>(!isBorrowed_)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (rhs.isBorrowed_) &#123;</span><br><span class="line">                own_.~<span class="built_in">T</span>();</span><br><span class="line">                MaybeOwnedTraits&lt;T&gt;::<span class="built_in">assignBorrow</span>(borrow_, rhs.borrow_);</span><br><span class="line">                isBorrowed_ = <span class="literal">true</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                own_ = rhs.own_;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">C10_LIKELY</span>(rhs.isBorrowed_)) &#123;</span><br><span class="line">                MaybeOwnedTraits&lt;T&gt;::<span class="built_in">assignBorrow</span>(borrow_, rhs.borrow_);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                MaybeOwnedTraits&lt;T&gt;::<span class="built_in">destroyBorrow</span>(borrow_);</span><br><span class="line">                <span class="keyword">new</span> (&amp;own_) <span class="built_in">T</span>(rhs.own_);</span><br><span class="line">                isBorrowed_ = <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">TORCH_INTERNAL_ASSERT_DEBUG_ONLY</span>(isBorrowed_ == rhs.isBorrowed_);</span><br><span class="line">        <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">MaybeOwned</span>(MaybeOwned&amp;&amp; rhs) <span class="built_in"><span class="keyword">noexcept</span></span>(</span><br><span class="line">        std::is_nothrow_move_constructible&lt;T&gt;::value)</span><br><span class="line">        : <span class="built_in">isBorrowed_</span>(rhs.isBorrowed_) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">C10_LIKELY</span>(rhs.isBorrowed_)) &#123;</span><br><span class="line">            MaybeOwnedTraits&lt;T&gt;::<span class="built_in">assignBorrow</span>(borrow_, rhs.borrow_);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in"><span class="keyword">new</span></span> (&amp;own_) <span class="built_in">T</span>(std::<span class="built_in">move</span>(rhs.own_));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    MaybeOwned&amp; <span class="keyword">operator</span>=(MaybeOwned&amp;&amp; rhs) <span class="built_in"><span class="keyword">noexcept</span></span>(</span><br><span class="line">        std::is_nothrow_move_assignable&lt;T&gt;::value) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span> == &amp;rhs) &#123;</span><br><span class="line">            <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">C10_UNLIKELY</span>(!isBorrowed_)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (rhs.isBorrowed_) &#123;</span><br><span class="line">                own_.~<span class="built_in">T</span>();</span><br><span class="line">                MaybeOwnedTraits&lt;T&gt;::<span class="built_in">assignBorrow</span>(borrow_, rhs.borrow_);</span><br><span class="line">                isBorrowed_ = <span class="literal">true</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                own_ = std::<span class="built_in">move</span>(rhs.own_);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">C10_LIKELY</span>(rhs.isBorrowed_)) &#123;</span><br><span class="line">                MaybeOwnedTraits&lt;T&gt;::<span class="built_in">assignBorrow</span>(borrow_, rhs.borrow_);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                MaybeOwnedTraits&lt;T&gt;::<span class="built_in">destroyBorrow</span>(borrow_);</span><br><span class="line">                <span class="keyword">new</span> (&amp;own_) <span class="built_in">T</span>(std::<span class="built_in">move</span>(rhs.own_));</span><br><span class="line">                isBorrowed_ = <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">TORCH_INTERNAL_ASSERT_DEBUG_ONLY</span>(isBorrowed_ == rhs.isBorrowed_);</span><br><span class="line">        <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">static</span> MaybeOwned <span class="title">borrowed</span><span class="params">(<span class="keyword">const</span> T&amp; t)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">MaybeOwned</span>(t);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">static</span> MaybeOwned <span class="title">owned</span><span class="params">(T&amp;&amp; t)</span> <span class="title">noexcept</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        std::is_nothrow_move_constructible&lt;T&gt;::value)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">MaybeOwned</span>(std::<span class="built_in">move</span>(t));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">template</span> &lt;class... Args&gt;</span><br><span class="line">    <span class="function"><span class="keyword">static</span> MaybeOwned <span class="title">owned</span><span class="params">(<span class="keyword">in_place_t</span>, Args&amp;&amp;... args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">MaybeOwned</span>(in_place, std::forward&lt;Args&gt;(args)...);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ~<span class="built_in">MaybeOwned</span>() &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">C10_UNLIKELY</span>(!isBorrowed_)) &#123;</span><br><span class="line">            own_.~<span class="built_in">T</span>();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            MaybeOwnedTraits&lt;T&gt;::<span class="built_in">destroyBorrow</span>(borrow_);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">unsafeIsBorrowed</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> isBorrowed_;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> T&amp; <span class="keyword">operator</span>*() <span class="keyword">const</span>&amp; &#123;</span><br><span class="line">        <span class="keyword">if</span> (isBorrowed_) &#123;</span><br><span class="line">            <span class="built_in">TORCH_INTERNAL_ASSERT_DEBUG_ONLY</span>(</span><br><span class="line">                MaybeOwnedTraits&lt;T&gt;::<span class="built_in">debugBorrowIsValid</span>(borrow_));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">C10_LIKELY</span>(isBorrowed_)</span><br><span class="line">            ? MaybeOwnedTraits&lt;T&gt;::<span class="built_in">referenceFromBorrow</span>(borrow_)</span><br><span class="line">            : own_;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> T* <span class="keyword">operator</span>-&gt;() <span class="keyword">const</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (isBorrowed_) &#123;</span><br><span class="line">            <span class="built_in">TORCH_INTERNAL_ASSERT_DEBUG_ONLY</span>(</span><br><span class="line">                MaybeOwnedTraits&lt;T&gt;::<span class="built_in">debugBorrowIsValid</span>(borrow_));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">C10_LIKELY</span>(isBorrowed_)</span><br><span class="line">            ? MaybeOwnedTraits&lt;T&gt;::<span class="built_in">pointerFromBorrow</span>(borrow_)</span><br><span class="line">            : &amp;own_;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    T <span class="keyword">operator</span>*() &amp;&amp; &#123;</span><br><span class="line">        <span class="keyword">if</span> (isBorrowed_) &#123;</span><br><span class="line">            <span class="built_in">TORCH_INTERNAL_ASSERT_DEBUG_ONLY</span>(</span><br><span class="line">                MaybeOwnedTraits&lt;T&gt;::<span class="built_in">debugBorrowIsValid</span>(borrow_));</span><br><span class="line">            <span class="keyword">return</span> MaybeOwnedTraits&lt;T&gt;::<span class="built_in">referenceFromBorrow</span>(borrow_);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> std::<span class="built_in">move</span>(own_);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></div></figure>
<p>基本上就是加了一些检查，然后对前面的 <code>MaybeOwnedTraits</code> 的一层封装。</p>

        <h1 id="intrusive_ptr"   >
          <a href="#intrusive_ptr" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#intrusive_ptr"></a> intrusive_ptr</h1>
      
<p><code>intrusive_ptr&lt;T&gt;</code> 是 <code>shared_ptr&lt;T&gt;</code> 的一个替代方案，它有更好的性能，因为它在内部进行引用计数（即在对象本身的一个成员中）。你的类 <code>T</code> 需要继承自 <code>intrusive_ptr_target</code> 以允许它被用于 <code>intrusive_ptr&lt;T&gt;</code> 。你的类的构造函数不应该允许 <code>this</code> 转移到其他线程或从 <code>this</code> 创建一个 <code>intrusive_ptr</code> 。</p>
<p><code>std::enable_shared_from_this</code> 的一个众所周知的问题是，它允许你从一个堆栈分配的对象中创建一个 <code>std::shared_ptr</code> ，这是完全错误的，因为一旦你从堆栈中返回，这个对象就会死亡。 在 <code>intrusive_ptr</code> 中，我们可以检测到这种情况的发生，因为我们将继承自 <code>intrusive_ptr_target</code> 的对象的引用计数或弱引用计数设置为零，<em>除非</em> 我们能证明该对象是动态分配的（例如，通过 <code>make_intrusive</code>）。</p>
<p>因此，每当你将一个 <code>T*</code> 转化为 <code>intrusive_ptr&lt;T&gt;</code> 时，我们就会检查并确保引用计数不是零（或者，对 <code>weak_intrusive_ptr&lt;T&gt;</code> 进行更微妙的测试，对于这种情况，引用计数可能有效地是零，但弱引用计数最好不是零），因为这告诉我们这个对象是否是由我们分配的。如果不是，就不要用 <code>intrusive_ptr</code> 了。</p>
<p>实现方案是这样的：</p>
<ul>
<li>
<p>引用计数等于对象的强引用数量；弱引用计数为对象的弱引用数量，如果引用计数大于零，再加一。不变式：引用计数大于零 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo>⇒</mo></mrow><annotation encoding="application/x-tex">\Rightarrow</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.36687em;vertical-align:0em;"></span><span class="mrel">⇒</span></span></span></span> 弱引用计数大于零。</p>
</li>
<li>
<p><code>c10::StorageImpl</code> 只要有任何强的或弱的指针指向它，它就一直活着（弱引用计数大于零，因为强引用算作弱引用计数的 +1）。</p>
</li>
<li>
<p>当引用计数为零时，析构器被调用，<code>data_ptr</code> 被释放。</p>
</li>
<li>
<p>一旦引用计数为零，它就不能再大于零了（从大于零到等于零的过渡是单调的）。</p>
</li>
<li>
<p>当你通过一个弱指针访问 <code>c10::StorageImpl</code> 时，如果它大于零，你必须原子化地增加使用计数，否则，你必须报告该存储已死。</p>
</li>
</ul>
<p><code>intrusive_ptr_target</code> 类（删减版）：</p>
<figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C10_API</span> <span class="title">intrusive_ptr_target</span> &#123;</span></span><br><span class="line">    <span class="keyword">mutable</span> std::atomic&lt;<span class="keyword">size_t</span>&gt; refcount_;</span><br><span class="line">    <span class="keyword">mutable</span> std::atomic&lt;<span class="keyword">size_t</span>&gt; weakcount_;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T, <span class="keyword">typename</span> NullType&gt;</span><br><span class="line">    <span class="keyword">friend</span> <span class="class"><span class="keyword">class</span> <span class="title">intrusive_ptr</span>;</span></span><br><span class="line">    <span class="keyword">friend</span> <span class="keyword">inline</span> <span class="keyword">void</span> raw::intrusive_ptr::<span class="built_in">incref</span>(intrusive_ptr_target* self);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T, <span class="keyword">typename</span> NullType&gt;</span><br><span class="line">    <span class="keyword">friend</span> <span class="class"><span class="keyword">class</span> <span class="title">weak_intrusive_ptr</span>;</span></span><br><span class="line">    <span class="keyword">friend</span> <span class="keyword">inline</span> <span class="keyword">void</span> raw::weak_intrusive_ptr::<span class="built_in">incref</span>(</span><br><span class="line">        intrusive_ptr_target* self);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">    <span class="keyword">friend</span> <span class="class"><span class="keyword">struct</span> <span class="title">ExclusivelyOwnedTraits</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">    <span class="keyword">virtual</span> ~<span class="built_in">intrusive_ptr_target</span>() </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">TORCH_INTERNAL_ASSERT_DEBUG_ONLY</span>(</span><br><span class="line">        refcount_.<span class="built_in">load</span>() == <span class="number">0</span> || refcount_.<span class="built_in">load</span>() &gt;= INT_MAX,</span><br><span class="line">        <span class="string">&quot;Tried to destruct an intrusive_ptr_target that still has intrusive_ptr to it; refcount was &quot;</span>,</span><br><span class="line">        refcount_.<span class="built_in">load</span>());</span><br><span class="line"></span><br><span class="line">        <span class="built_in">TORCH_INTERNAL_ASSERT_DEBUG_ONLY</span>(</span><br><span class="line">        weakcount_.<span class="built_in">load</span>() == <span class="number">1</span> || weakcount_.<span class="built_in">load</span>() == <span class="number">0</span> ||</span><br><span class="line">            weakcount_.<span class="built_in">load</span>() == INT_MAX - <span class="number">1</span> || weakcount_.<span class="built_in">load</span>() == INT_MAX,</span><br><span class="line">        <span class="string">&quot;Tried to destruct an intrusive_ptr_target that still has weak_intrusive_ptr to it&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">constexpr</span> <span class="title">intrusive_ptr_target</span><span class="params">()</span> <span class="keyword">noexcept</span> : refcount_(<span class="number">0</span>), weakcount_(<span class="number">0</span>) &#123;</span>&#125;</span><br><span class="line">  </span><br><span class="line">    <span class="built_in">intrusive_ptr_target</span>(intrusive_ptr_target&amp;&amp; other) <span class="keyword">noexcept</span></span><br><span class="line">        : <span class="built_in">intrusive_ptr_target</span>() &#123;&#125;</span><br><span class="line">    intrusive_ptr_target&amp; <span class="keyword">operator</span>=(intrusive_ptr_target&amp;&amp; other) <span class="keyword">noexcept</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">release_resources</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></div></figure>
<p><code>intrusive_ptr_target</code> 内有原子 <code>size_t</code> 类型的 <code>refcount_</code> 和 <code>weakcount_</code> 以保证线程安全性。另外有两个友元类，<code>intrusive_ptr</code> 和 <code>weak_intrusive_ptr</code> 以及相应的 <code>incref</code> 友元函数。之后还有友元类：<code>ExclusivelyOwnedTraits</code> 。</p>
<p>当引用计数达到零时，会调用 <code>release_resources()</code> 。你可以覆盖它来释放昂贵的资源。可能仍然有弱引用，所以你的对象可能还没有被析构，但你可以假设这个对象不再被使用了，即不再调用方法或访问成员（我们只是还不能析构它，因为我们需要弱引用计数的访问）。<br />
即使没有弱引用（即你的类即将被析构），<code>release_resources()</code> 也保证会被首先调用。然而，如果你将你的类用于堆栈中被作用域析构的对象（即没有 <code>intrusive_ptr</code>），该函数将不会被调用。</p>
<p>下面看一下 <code>intrusive_ptr</code> 的实现（删减版）：</p>
<figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">TTarget</span>,</span></span><br><span class="line"><span class="class">    <span class="keyword">class</span> <span class="title">NullType</span> =</span> detail::intrusive_target_default_null_type&lt;TTarget&gt;&gt;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">intrusive_ptr</span> <span class="keyword">final</span> &#123;</span></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line"></span><br><span class="line">    <span class="built_in"><span class="keyword">static_assert</span></span>(</span><br><span class="line">        std::is_base_of&lt;</span><br><span class="line">            TTarget,</span><br><span class="line">            <span class="keyword">typename</span> std::remove_pointer&lt;<span class="keyword">decltype</span>(NullType::<span class="built_in">singleton</span>())&gt;::type&gt;::</span><br><span class="line">            value,</span><br><span class="line">        <span class="string">&quot;NullType::singleton() must return a element_type* pointer&quot;</span>);</span><br><span class="line"></span><br><span class="line">    TTarget* target_;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">    <span class="keyword">friend</span> <span class="class"><span class="keyword">struct</span> <span class="title">ExclusivelyOwnedTraits</span>;</span></span><br><span class="line">    <span class="keyword">template</span> &lt;<span class="class"><span class="keyword">class</span> <span class="title">TTarget2</span>, <span class="keyword">class</span> <span class="title">NullType2</span>&gt;</span></span><br><span class="line">    <span class="keyword">friend</span> <span class="class"><span class="keyword">class</span> <span class="title">intrusive_ptr</span>;</span></span><br><span class="line">    <span class="keyword">friend</span> <span class="class"><span class="keyword">class</span> <span class="title">weak_intrusive_ptr</span>&lt;</span>TTarget, NullType&gt;;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">retain_</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (target_ != NullType::<span class="built_in">singleton</span>()) &#123;</span><br><span class="line">            <span class="keyword">size_t</span> new_refcount =</span><br><span class="line">                detail::<span class="built_in">atomic_refcount_increment</span>(target_-&gt;refcount_);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">reset_</span><span class="params">()</span> <span class="keyword">noexcept</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (target_ != NullType::<span class="built_in">singleton</span>() &amp;&amp;</span><br><span class="line">            detail::<span class="built_in">atomic_refcount_decrement</span>(target_-&gt;refcount_) == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">const_cast</span>&lt;std::<span class="keyword">remove_const_t</span>&lt;TTarget&gt;*&gt;(target_)-&gt;<span class="built_in">release_resources</span>();</span><br><span class="line">            <span class="keyword">if</span> (target_-&gt;weakcount_.<span class="built_in">load</span>(std::memory_order_acquire) == <span class="number">1</span> ||</span><br><span class="line">                detail::<span class="built_in">atomic_weakcount_decrement</span>(target_-&gt;weakcount_) == <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">delete</span> target_;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        target_ = NullType::<span class="built_in">singleton</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">explicit</span> <span class="title">intrusive_ptr</span><span class="params">(TTarget* target)</span></span></span><br><span class="line"><span class="function">        : intrusive_ptr(target, raw::DontIncreaseRefcount&#123;</span>&#125;) &#123;</span><br><span class="line">        <span class="keyword">if</span> (target_ != NullType::<span class="built_in">singleton</span>()) &#123;</span><br><span class="line">            target_-&gt;refcount_.<span class="built_in">store</span>(<span class="number">1</span>, std::memory_order_relaxed);</span><br><span class="line">            target_-&gt;weakcount_.<span class="built_in">store</span>(<span class="number">1</span>, std::memory_order_relaxed);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">using</span> element_type = TTarget;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">intrusive_ptr</span>() <span class="keyword">noexcept</span></span><br><span class="line">        : <span class="built_in">intrusive_ptr</span>(NullType::<span class="built_in">singleton</span>(), raw::DontIncreaseRefcount&#123;&#125;) &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">explicit</span> <span class="title">intrusive_ptr</span><span class="params">(TTarget* target, raw::DontIncreaseRefcount)</span> <span class="keyword">noexcept</span></span></span><br><span class="line"><span class="function">        : target_(target) &#123;</span>&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">explicit</span> <span class="title">intrusive_ptr</span><span class="params">(std::unique_ptr&lt;TTarget&gt; rhs)</span> <span class="keyword">noexcept</span></span></span><br><span class="line"><span class="function">        : intrusive_ptr(rhs.release()) &#123;</span>&#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">intrusive_ptr</span>(intrusive_ptr&amp;&amp; rhs) <span class="keyword">noexcept</span> : <span class="built_in">target_</span>(rhs.target_) &#123;</span><br><span class="line">        rhs.target_ = NullType::<span class="built_in">singleton</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">template</span> &lt;<span class="class"><span class="keyword">class</span> <span class="title">From</span>, <span class="keyword">class</span> <span class="title">FromNullType</span>&gt;</span></span><br><span class="line">    <span class="comment">/* implicit */</span> <span class="built_in">intrusive_ptr</span>(intrusive_ptr&lt;From, FromNullType&gt;&amp;&amp; rhs) <span class="keyword">noexcept</span></span><br><span class="line">        : <span class="built_in">target_</span>(</span><br><span class="line">                detail::assign_ptr_&lt;TTarget, NullType, FromNullType&gt;(rhs.target_)) &#123;</span><br><span class="line">        rhs.target_ = FromNullType::<span class="built_in">singleton</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ~<span class="built_in">intrusive_ptr</span>() <span class="keyword">noexcept</span> &#123;</span><br><span class="line">        <span class="built_in">reset_</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">template</span> &lt;<span class="class"><span class="keyword">class</span> <span class="title">From</span>, <span class="keyword">class</span> <span class="title">FromNullType</span>&gt;</span></span><br><span class="line">    intrusive_ptr&amp; <span class="keyword">operator</span>=(intrusive_ptr&lt;From, FromNullType&gt;&amp;&amp; rhs) &amp; <span class="keyword">noexcept</span> &#123;</span><br><span class="line">        intrusive_ptr tmp = std::<span class="built_in">move</span>(rhs);</span><br><span class="line">        <span class="built_in">swap</span>(tmp);</span><br><span class="line">        <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">TTarget* <span class="title">get</span><span class="params">()</span> <span class="keyword">const</span> <span class="keyword">noexcept</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> target_;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    TTarget&amp; <span class="keyword">operator</span>*() <span class="keyword">const</span> <span class="keyword">noexcept</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> *target_;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    TTarget* <span class="keyword">operator</span>-&gt;() <span class="keyword">const</span> <span class="keyword">noexcept</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> target_;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">operator</span> <span class="title">bool</span><span class="params">()</span> <span class="keyword">const</span> <span class="keyword">noexcept</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> target_ != NullType::<span class="built_in">singleton</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">defined</span><span class="params">()</span> <span class="keyword">const</span> <span class="keyword">noexcept</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> target_ != NullType::<span class="built_in">singleton</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">size_t</span> <span class="title">use_count</span><span class="params">()</span> <span class="keyword">const</span> <span class="keyword">noexcept</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (target_ == NullType::<span class="built_in">singleton</span>()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> target_-&gt;refcount_.<span class="built_in">load</span>(std::memory_order_acquire);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">size_t</span> <span class="title">weak_use_count</span><span class="params">()</span> <span class="keyword">const</span> <span class="keyword">noexcept</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (target_ == NullType::<span class="built_in">singleton</span>()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> target_-&gt;weakcount_.<span class="built_in">load</span>(std::memory_order_acquire);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">TTarget* <span class="title">release</span><span class="params">()</span> <span class="keyword">noexcept</span> </span>&#123;</span><br><span class="line">        TTarget* result = target_;</span><br><span class="line">        target_ = NullType::<span class="built_in">singleton</span>();</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">   </span><br><span class="line">    <span class="function"><span class="keyword">static</span> intrusive_ptr <span class="title">reclaim</span><span class="params">(TTarget* owning_ptr)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">intrusive_ptr</span>(owning_ptr, raw::DontIncreaseRefcount&#123;&#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">static</span> intrusive_ptr <span class="title">reclaim_copy</span><span class="params">(TTarget* owning_ptr)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">auto</span> ret = <span class="built_in">reclaim</span>(owning_ptr);</span><br><span class="line">        ret.<span class="built_in">retain_</span>();</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">template</span> &lt;class... Args&gt;</span><br><span class="line">    <span class="function"><span class="keyword">static</span> intrusive_ptr <span class="title">make</span><span class="params">(Args&amp;&amp;... args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">intrusive_ptr</span>(<span class="keyword">new</span> <span class="built_in">TTarget</span>(std::forward&lt;Args&gt;(args)...));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">static</span> intrusive_ptr <span class="title">unsafe_steal_from_new</span><span class="params">(TTarget* raw_ptr)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">intrusive_ptr</span>(raw_ptr);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">static</span> intrusive_ptr <span class="title">unsafe_adapt_non_heap_allocated</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        TTarget* raw_ptr,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="keyword">size_t</span> expected_decrefs)</span> </span>&#123;</span><br><span class="line">        <span class="function">intrusive_ptr <span class="title">result</span><span class="params">(raw_ptr, raw::DontIncreaseRefcount&#123;&#125;)</span></span>;</span><br><span class="line">        <span class="meta">#<span class="meta-keyword">ifdef</span> NDEBUG</span></span><br><span class="line">            expected_decrefs = <span class="number">0</span>;</span><br><span class="line">        <span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">        result.target_-&gt;refcount_.<span class="built_in">store</span>(</span><br><span class="line">            INT_MAX + expected_decrefs, std::memory_order_relaxed);</span><br><span class="line">        result.target_-&gt;weakcount_.<span class="built_in">store</span>(INT_MAX, std::memory_order_relaxed);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">static</span> intrusive_ptr <span class="title">unsafe_reclaim_from_nonowning</span><span class="params">(TTarget* raw_ptr)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">auto</span> ptr = <span class="built_in">reclaim</span>(raw_ptr); <span class="comment">// doesn&#x27;t increase refcount</span></span><br><span class="line">        ptr.<span class="built_in">retain_</span>();</span><br><span class="line">        <span class="keyword">return</span> ptr;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></div></figure>
<p>其中，<code>detail</code> 命名空间的部分实现：</p>
<figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="class"><span class="keyword">class</span> <span class="title">TTarget</span>&gt;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">intrusive_target_default_null_type</span> <span class="keyword">final</span> &#123;</span></span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">constexpr</span> TTarget* <span class="title">singleton</span><span class="params">()</span> <span class="keyword">noexcept</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="class"><span class="keyword">class</span> <span class="title">TTarget</span>, <span class="keyword">class</span> <span class="title">ToNullType</span>, <span class="keyword">class</span> <span class="title">FromNullType</span>&gt;</span></span><br><span class="line"><span class="function">TTarget* <span class="title">assign_ptr_</span><span class="params">(TTarget* rhs)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (FromNullType::<span class="built_in">singleton</span>() == rhs) &#123;</span><br><span class="line">        <span class="keyword">return</span> ToNullType::<span class="built_in">singleton</span>();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> rhs;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">size_t</span> <span class="title">atomic_refcount_increment</span><span class="params">(std::atomic&lt;<span class="keyword">size_t</span>&gt;&amp; refcount)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> refcount.<span class="built_in">fetch_add</span>(<span class="number">1</span>, std::memory_order_acq_rel) + <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<p>除此之外，还有一些辅助方法：</p>
<figure class="highlight cpp"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">TTarget</span>,</span></span><br><span class="line"><span class="class">    <span class="keyword">class</span> <span class="title">NullType</span> =</span> detail::intrusive_target_default_null_type&lt;TTarget&gt;,</span><br><span class="line">    class... Args&gt;</span><br><span class="line"><span class="function"><span class="keyword">inline</span> intrusive_ptr&lt;TTarget, NullType&gt; <span class="title">make_intrusive</span><span class="params">(Args&amp;&amp;... args)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> intrusive_ptr&lt;TTarget, NullType&gt;::<span class="built_in">make</span>(std::forward&lt;Args&gt;(args)...);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="class"><span class="keyword">class</span> <span class="title">TTarget</span>, <span class="keyword">class</span> <span class="title">NullType</span>&gt;</span></span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">swap</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    intrusive_ptr&lt;TTarget, NullType&gt;&amp; lhs,</span></span></span><br><span class="line"><span class="params"><span class="function">    intrusive_ptr&lt;TTarget, NullType&gt;&amp; rhs)</span> <span class="keyword">noexcept</span> </span>&#123;</span><br><span class="line">    lhs.<span class="built_in">swap</span>(rhs);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="class"><span class="keyword">class</span> <span class="title">TTarget1</span>, <span class="keyword">class</span> <span class="title">NullType1</span>, <span class="keyword">class</span> <span class="title">TTarget2</span>, <span class="keyword">class</span> <span class="title">NullType2</span>&gt;</span></span><br><span class="line"><span class="keyword">inline</span> <span class="keyword">bool</span> <span class="keyword">operator</span>&lt;(</span><br><span class="line">    <span class="keyword">const</span> intrusive_ptr&lt;TTarget1, NullType1&gt;&amp; lhs,</span><br><span class="line">    <span class="keyword">const</span> intrusive_ptr&lt;TTarget2, NullType2&gt;&amp; rhs) <span class="keyword">noexcept</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> lhs.<span class="built_in">get</span>() &lt; rhs.<span class="built_in">get</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* other operators... */</span></span><br></pre></td></tr></table></div></figure>
</div><footer class="post-footer"><div class="post-ending ending"><div class="ending__text">------ 本文结束，感谢您的阅读 ------</div></div><div class="post-copyright copyright"><div class="copyright-author"><span class="copyright-author__name">本文作者: </span><span class="copyright-author__value"><a href="https://aurumting.cn">Aurumting</a></span></div><div class="copyright-link"><span class="copyright-link__name">本文链接: </span><span class="copyright-link__value"><a href="https://aurumting.cn/2021/12/07/PyTorch_intrusive_ptr/">https://aurumting.cn/2021/12/07/PyTorch_intrusive_ptr/</a></span></div><div class="copyright-notice"><span class="copyright-notice__name">版权声明: </span><span class="copyright-notice__value">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.en" rel="external nofollow" target="_blank">BY-NC-SA</a> 许可协议。转载请注明出处！</span></div></div><div class="post-tags"><span class="post-tags-item"><span class="post-tags-item__icon"><i class="fas fa-tag"></i></span><a class="post-tags-item__link" href="https://aurumting.cn/tags/PyTorch/">PyTorch</a></span></div><nav class="post-paginator paginator"><div class="paginator-next"><a class="paginator-next__link" href="/2021/12/04/PyTorch_c10/"><span class="paginator-prev__text">PyTorch 源码阅读：c10</span><span class="paginator-next__icon"><i class="fas fa-angle-right"></i></span></a></div></nav></footer></div></div><div class="comments" id="comments"><div id="gitalk-container"></div></div></div><div class="sidebar-wrap" id="sidebar-wrap"><aside class="sidebar" id="sidebar"><div class="sidebar-nav"><span class="sidebar-nav-toc current">文章目录</span><span class="sidebar-nav-ov">站点概览</span></div><section class="sidebar-toc"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#in_place"><span class="toc-number">1.</span> <span class="toc-text">
           in_place</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#exclusivelyowned"><span class="toc-number">2.</span> <span class="toc-text">
           ExclusivelyOwned</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#maybeowned"><span class="toc-number">3.</span> <span class="toc-text">
           MaybeOwned</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#intrusive_ptr"><span class="toc-number">4.</span> <span class="toc-text">
           intrusive_ptr</span></a></li></ol></section><!-- ov = overview--><section class="sidebar-ov hide"><div class="sidebar-ov-author"><div class="sidebar-ov-author__avatar"><img class="sidebar-ov-author__avatar_img" src="/images/avatar.jpg" alt="avatar"></div><p class="sidebar-ov-author__text">雄城壮看江山无恙， 谁识我一蓑一笠到天涯</p></div><div class="sidebar-ov-social"><a class="sidebar-ov-social-item" href="https://github.com/Aurainting" target="_blank" rel="noopener" data-popover="Github" data-popover-pos="up"><span class="sidebar-ov-social-item__icon"><i class="fab fa-github"></i></span></a><a class="sidebar-ov-social-item" href="https://blog.csdn.net/qq_46013251" target="_blank" rel="noopener" data-popover="social.csdn" data-popover-pos="up"><span class="sidebar-ov-social-item__icon">CSDN</span></a></div><div class="sidebar-ov-state"><a class="sidebar-ov-state-item sidebar-ov-state-item--posts" href="/archives/"><div class="sidebar-ov-state-item__count">3</div><div class="sidebar-ov-state-item__name">归档</div></a><a class="sidebar-ov-state-item sidebar-ov-state-item--categories" href="/categories/"><div class="sidebar-ov-state-item__count">2</div><div class="sidebar-ov-state-item__name">分类</div></a><a class="sidebar-ov-state-item sidebar-ov-state-item--tags" href="/tags/"><div class="sidebar-ov-state-item__count">3</div><div class="sidebar-ov-state-item__name">标签</div></a></div><div class="sidebar-ov-cc"><a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.en" target="_blank" rel="noopener" data-popover="知识共享许可协议" data-popover-pos="up"><img src="/images/cc-by-nc-sa.svg"></a></div></section><div class="sidebar-reading"><div class="sidebar-reading-info"><span class="sidebar-reading-info__text">你已阅读了 </span><span class="sidebar-reading-info__num">0</span><span class="sidebar-reading-info__perc">%</span></div><div class="sidebar-reading-line"></div></div></aside></div><div class="clearfix"></div></div></main><footer class="footer" id="footer"><div class="footer-inner"><div><span>Copyright © 2021</span><span class="footer__icon"><i class="fas fa-heart"></i></span><span>Aurumting</span></div><div class="busuanzi"><span class="busuanzi-siteuv"><span class="busuanzi-siteuv__icon"><i class="fas fa-user"></i></span><span class="busuanzi-siteuv__info">访问人数</span><span class="busuanzi-siteuv__value" id="busuanzi_value_site_uv"></span></span><span class="busuanzi-sitepv"><span class="busuanzi-siteuv__icon"><i class="fas fa-eye"></i></span><span class="busuanzi-siteuv__info">浏览总量</span><span class="busuanzi-siteuv__value" id="busuanzi_value_site_pv"></span></span></div></div></footer><div class="loading-bar" id="loading-bar"><div class="loading-bar__progress"></div></div><div class="back2top" id="back2top"><span class="back2top__icon"><i class="fas fa-rocket"></i></span></div></div><script src="https://cdn.jsdelivr.net/npm/jquery@v3.4.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@1.5.2/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@1.5.2/velocity.ui.min.js"></script><script src="https://cdn.jsdelivr.net/npm/ribbon.js@latest/dist/ribbon.min.js" size="120" alpha="0.6" zIndex="-1"></script><script src="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script><link href="https://cdn.jsdelivr.net/npm/katex@0.10.2/dist/katex.min.css" rel="stylesheet" type="text/css"><link href="https://cdn.jsdelivr.net/npm/katex@0.10.2/dist/contrib/copy-tex.css" rel="stylesheet" type="text/css"><script src="https://cdn.jsdelivr.net/npm/katex@0.10.2/dist/contrib/copy-tex.min.js"></script><script src="https://cdn.jsdelivr.net/gh/sukkaw/busuanzi@latest/bsz.pure.mini.js" async></script><script src="https://cdn.jsdelivr.net/npm/gitalk@latest/dist/gitalk.min.js"></script><script src="https://cdn.jsdelivr.net/npm/js-md5@latest/src/md5.min.js"></script><script>function loadGitalk () {
  if (!document.getElementById('gitalk-container')) {
    return;
  }

  var gitalk = new Gitalk({
    id: md5(window.location.pathname.slice(1)),
    clientID: 'bd415213fa1c103f9a58',
    clientSecret: '2d3be9e5c363bb13f8df7b00305316e3a9f03059',
    repo: 'Aurainting.github.io',
    owner: 'Aurainting',
    admin: ['Aurainting'],
    distractionFreeMode: 'false',
    language: 'zh-CN'
  });
  gitalk.render('gitalk-container');
}

if (false) {
  loadGitalk();
} else {
  window.addEventListener('DOMContentLoaded', loadGitalk, false);
}</script><script src="/js/utils.js?v=2.6.2"></script><script src="/js/stun-boot.js?v=2.6.2"></script><script src="/js/scroll.js?v=2.6.2"></script><script src="/js/header.js?v=2.6.2"></script><script src="/js/sidebar.js?v=2.6.2"></script></body></html>